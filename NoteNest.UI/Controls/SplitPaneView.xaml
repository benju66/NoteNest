<UserControl x:Class="NoteNest.UI.Controls.SplitPaneView"
             x:Name="ThisControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:local="clr-namespace:NoteNest.UI.Controls"
             xmlns:editor="clr-namespace:NoteNest.UI.Controls.Editor.Core"
             xmlns:editorControls="clr-namespace:NoteNest.UI.Controls.Editor"
             xmlns:behaviors="clr-namespace:NoteNest.UI.Behaviors"
             mc:Ignorable="d">
    <UserControl.InputBindings>
        <KeyBinding Key="F2" Command="{Binding RenameSelectedTabCommand, ElementName=ThisControl}"/>
        <KeyBinding Key="W" Modifiers="Ctrl" Command="{Binding CloseSelectedTabCommand, ElementName=ThisControl}"/>
    </UserControl.InputBindings>
    <Border x:Name="PaneBorder" 
            BorderThickness="2" 
            BorderBrush="Transparent">
        <Grid>
            <local:DraggableTabControl x:Name="PaneTabControl"
                        behaviors:TabOverflowBehavior.EnableOverflow="True"
                        SelectionChanged="TabControl_SelectionChanged"
                        GotFocus="TabControl_GotFocus">
                <local:DraggableTabControl.ItemTemplate>
                    <DataTemplate>
                        <StackPanel Orientation="Horizontal"
                                    PreviewMouseDown="TabHeader_PreviewMouseDown"
                                    ToolTip="{Binding Note.FilePath}">
                            <StackPanel.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="_Rename..."
                                              Click="RenameTab_Click"
                                              Tag="{Binding}"
                                              InputGestureText="F2">
                                        <MenuItem.Icon>
                                            <Path Data="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25zM20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83 3.75,3.75 1.83-1.83z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <Separator/>

                                    <MenuItem Header="_Close"
                                              Click="CloseTab_Click"
                                              Tag="{Binding}"
                                              InputGestureText="Ctrl+W">
                                        <MenuItem.Icon>
                                            <Path Data="M19,6.41L17.59,5 12,10.59 6.41,5 5,6.41 10.59,12 5,17.59 6.41,19 12,13.41 17.59,19 19,17.59 13.41,12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="Close _All"
                                              Click="CloseAllTabs_Click">
                                        <MenuItem.Icon>
                                            <Path Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="Close _Others"
                                              Click="CloseOthers_Click"
                                              Tag="{Binding}">
                                        <MenuItem.Icon>
                                            <Path Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <Separator/>

                                    <MenuItem Header="_Save"
                                              Click="SaveTab_Click"
                                              Tag="{Binding}"
                                              IsEnabled="{Binding IsDirty}"
                                              InputGestureText="Ctrl+S">
                                        <MenuItem.Icon>
                                            <Path Data="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </StackPanel.ContextMenu>
                            <TextBlock Margin="5,2" VerticalAlignment="Center" Text="{Binding Note.Title}" 
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            <TextBlock Text="·" Margin="2,2,0,2" Foreground="{DynamicResource SystemControlForegroundAccentBrush}" VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <Button Content="×" 
                                    Click="CloseTab_Click"
                                    Tag="{Binding}"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Padding="5,0"
                                    Margin="3,0,0,0"
                                    FontSize="14"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                    Cursor="Hand"/>
                        </StackPanel>
                    </DataTemplate>
                </local:DraggableTabControl.ItemTemplate>
                <local:DraggableTabControl.ContentTemplate>
                    <DataTemplate>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Per-tab toolbar -->
                            <editorControls:EditorToolbar Grid.Row="0" 
                                                          Editor="{Binding ElementName=FormattedEditor}"/>

                            <!-- Note content viewer: always-formatted editor -->
                            <editor:FormattedTextEditor x:Name="FormattedEditor"
                                                      Grid.Row="1"
                                                      VerticalScrollBarVisibility="Auto"
                                                      HorizontalScrollBarVisibility="Disabled"
                                                      Focusable="True"
                                                      IsDocumentEnabled="True"
                                                      IsHitTestVisible="True"
                                                      Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                                                      MarkdownContent="{Binding Content, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                      TextChanged="SmartEditor_TextChanged"/>
                        </Grid>
                    </DataTemplate>
                </local:DraggableTabControl.ContentTemplate>
            </local:DraggableTabControl>
            
            <!-- Show message when no tabs -->
            <TextBlock x:Name="EmptyMessage"
                       Text="No tabs open"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       FontStyle="Italic"
                       Visibility="Collapsed"/>
        </Grid>
    </Border>
</UserControl>


