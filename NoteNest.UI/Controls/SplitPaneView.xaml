<UserControl x:Class="NoteNest.UI.Controls.SplitPaneView"
             x:Name="ThisControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:local="clr-namespace:NoteNest.UI.Controls"
             xmlns:rtf="clr-namespace:NoteNest.UI.Controls.Editor.RTF"
             xmlns:behaviors="clr-namespace:NoteNest.UI.Behaviors"
             mc:Ignorable="d">
    <UserControl.InputBindings>
        <KeyBinding Key="F2" Command="{Binding RenameSelectedTabCommand, ElementName=ThisControl}"/>
        <KeyBinding Key="W" Modifiers="Ctrl" Command="{Binding CloseSelectedTabCommand, ElementName=ThisControl}"/>
    </UserControl.InputBindings>
    <Border x:Name="PaneBorder" 
            BorderThickness="2" 
            BorderBrush="Transparent">
        <Grid>
             <local:DraggableTabControl x:Name="PaneTabControl"
                         behaviors:TabOverflowBehavior.EnableOverflow="True"
                         SelectionChanged="TabControl_SelectionChanged"
                         GotFocus="TabControl_GotFocus"
                         VirtualizingPanel.IsVirtualizing="False">
                <local:DraggableTabControl.ItemTemplate>
                    <DataTemplate>
                        <!-- BULLETPROOF TAB LAYOUT: Grid ensures close button is always accessible -->
                        <Grid MaxWidth="200" 
                              PreviewMouseDown="TabHeader_PreviewMouseDown"
                              ToolTip="{Binding Note.FilePath}">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>        <!-- RTF title area - takes available space -->
                                <ColumnDefinition Width="Auto"/>     <!-- Dirty indicator -->  
                                <ColumnDefinition Width="24"/>       <!-- Fixed space for close button -->
                            </Grid.ColumnDefinitions>
                            <Grid.ContextMenu>
                                <ContextMenu>
                                    <MenuItem Header="_Rename..."
                                              Click="RenameTab_Click"
                                              Tag="{Binding}"
                                              InputGestureText="F2">
                                        <MenuItem.Icon>
                                            <Path Data="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25zM20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83 3.75,3.75 1.83-1.83z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <Separator/>

                                    <MenuItem Header="_Close"
                                              Click="CloseTab_Click"
                                              Tag="{Binding}"
                                              InputGestureText="Ctrl+W">
                                        <MenuItem.Icon>
                                            <Path Data="M19,6.41L17.59,5 12,10.59 6.41,5 5,6.41 10.59,12 5,17.59 6.41,19 12,13.41 17.59,19 19,17.59 13.41,12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="Close _All"
                                              Click="CloseAllTabs_Click">
                                        <MenuItem.Icon>
                                            <Path Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <MenuItem Header="Close _Others"
                                              Click="CloseOthers_Click"
                                              Tag="{Binding}">
                                        <MenuItem.Icon>
                                            <Path Data="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>

                                    <Separator/>

                                    <MenuItem Header="_Save"
                                              Click="SaveTab_Click"
                                              Tag="{Binding}"
                                              IsEnabled="{Binding IsDirty}"
                                              InputGestureText="Ctrl+S">
                                        <MenuItem.Icon>
                                            <Path Data="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"
                                                  Fill="{DynamicResource SystemControlForegroundBaseHighBrush}"
                                                  Stretch="Uniform"
                                                  Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Grid.ContextMenu>
                            
                            <!-- RTF Title with ellipsis truncation -->
                            <TextBlock Grid.Column="0"
                                       Margin="5,2,2,2" 
                                       VerticalAlignment="Center" 
                                       Text="{Binding Note.Title}"
                                       TextTrimming="CharacterEllipsis"
                                       Foreground="{DynamicResource SystemControlForegroundBaseHighBrush}"/>
                            
                            <!-- Dirty indicator -->
                            <TextBlock Grid.Column="1" 
                                       Text="·" 
                                       Margin="2,2,2,2" 
                                       Foreground="{DynamicResource SystemControlForegroundAccentBrush}" 
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            
                            <!-- Always-accessible close button -->
                            <Button Grid.Column="2"
                                    Content="×" 
                                    Click="CloseTab_Click"
                                    Tag="{Binding}"
                                    Width="20" Height="20"
                                    Margin="2,1"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    FontSize="14"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                                    Cursor="Hand"
                                    ToolTip="Close tab"/>
                        </Grid>
                    </DataTemplate>
                </local:DraggableTabControl.ItemTemplate>
                <local:DraggableTabControl.ContentTemplate>
                    <DataTemplate>
                        <!-- TAB-OWNED EDITOR PATTERN: Display the tab's complete UI -->
                        <!-- The tab owns the complete UI: Grid + Toolbar + Editor -->
                        <ContentPresenter Content="{Binding TabContent}" />
                    </DataTemplate>
                </local:DraggableTabControl.ContentTemplate>
            </local:DraggableTabControl>
            
            <!-- Show message when no tabs -->
            <TextBlock x:Name="EmptyMessage"
                       Text="No tabs open"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                       FontStyle="Italic"
                       Visibility="Collapsed"/>
        </Grid>
    </Border>
</UserControl>


