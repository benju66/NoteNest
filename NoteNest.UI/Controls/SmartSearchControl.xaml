<UserControl x:Class="NoteNest.UI.Controls.SmartSearchControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:NoteNest.UI.ViewModels"
             xmlns:services="clr-namespace:NoteNest.UI.Services"
             xmlns:converters="clr-namespace:NoteNest.UI.Converters"
             x:Name="SearchControlRoot">
    
    <UserControl.Resources>
        <!-- Converter for boolean to visibility -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <!-- Converter for highlighted text -->
        <converters:HighlightedTextConverter x:Key="HighlightedTextConverter"/>
    </UserControl.Resources>
    
    <Grid ClipToBounds="False" Background="Transparent">
        <!-- Search input with icon -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Custom TextBox styled like AutoSuggestBox -->
            <Border x:Name="SearchBoxBorder"
                    Grid.Column="0"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    BorderThickness="1"
                    Background="{DynamicResource AppSurfaceBrush}"
                    CornerRadius="2">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Search Icon -->
                    <TextBlock Grid.Column="0" 
                              Text="&#xE721;"
                              FontFamily="Segoe MDL2 Assets"
                              FontSize="14"
                              Margin="8,0,4,0"
                              VerticalAlignment="Center"
                              Opacity="0.6"/>
                    
                    <!-- Search TextBox -->
                    <TextBox x:Name="SearchTextBox"
                            Grid.Column="1"
                            Text="{Binding SearchQuery, UpdateSourceTrigger=PropertyChanged, Mode=TwoWay}"
                            BorderThickness="0"
                            Background="Transparent"
                            VerticalAlignment="Center"
                            Padding="4,6"
                              FontSize="14"
                            PreviewKeyDown="SearchTextBox_PreviewKeyDown"
                            GotFocus="SearchTextBox_GotFocus"
                            LostFocus="SearchTextBox_LostFocus">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="TextBox">
                                            <Grid>
                                                <!-- Placeholder text -->
                                                <TextBlock Text="Search notes... (Ctrl+F)"
                                                          Opacity="0.5"
                              VerticalAlignment="Center"
                                                          Margin="4,0,0,0"
                                                          IsHitTestVisible="False">
                                                    <TextBlock.Style>
                                                        <Style TargetType="TextBlock">
                                                            <Style.Triggers>
                                                                <DataTrigger Binding="{Binding Text.Length, RelativeSource={RelativeSource TemplatedParent}}" Value="0">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                </DataTrigger>
                                                            </Style.Triggers>
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </Style>
                                                    </TextBlock.Style>
                                                </TextBlock>
                                                
                                                <!-- Actual TextBox content -->
                                                <ScrollViewer x:Name="PART_ContentHost"
                                                            Focusable="false"
                                                            HorizontalScrollBarVisibility="Hidden"
                                                            VerticalScrollBarVisibility="Hidden"/>
                                            </Grid>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                    
                    <!-- Clear button (visible when has text) -->
                    <Button Grid.Column="2"
                           x:Name="ClearButton"
                           Content="&#xE711;"
                           FontFamily="Segoe MDL2 Assets"
                           FontSize="12"
                           Background="Transparent"
                           BorderThickness="0"
                           Padding="4,0"
                           Margin="0,0,4,0"
                           VerticalAlignment="Center"
                           Click="ClearButton_Click"
                           Visibility="{Binding HasText, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>
            </Border>
        </Grid>
        
        <!-- Custom Popup for search results -->
        <Popup x:Name="ResultsPopup"
               PlacementTarget="{Binding ElementName=SearchBoxBorder}"
               Placement="Bottom"
               StaysOpen="False"
               AllowsTransparency="True"
               PopupAnimation="None"
               IsOpen="{Binding ShowDropdown, Mode=TwoWay}"
               MaxHeight="400"
               HorizontalOffset="0"
               VerticalOffset="2"
               MinWidth="{Binding ActualWidth, ElementName=SearchBoxBorder}"
               Width="{Binding ActualWidth, ElementName=SearchBoxBorder}"
               Focusable="False">
            
            <Border Background="{DynamicResource AppSurfaceBrush}"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="0,0,2,2">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="8" 
                                     ShadowDepth="2" 
                                     Opacity="0.2" 
                                     Color="Black"/>
                </Border.Effect>
                
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/> <!-- Error panel -->
                        <RowDefinition Height="*"/>    <!-- Results list -->
                        <RowDefinition Height="Auto"/> <!-- Status bar -->
                    </Grid.RowDefinitions>
                    
                    <!-- Error Message Panel -->
                    <Border Grid.Row="0" 
                           Background="#FFFFE0E0" 
                           Padding="12,8"
                           BorderBrush="#FFCC0000"
                           BorderThickness="0,0,0,1"
                           Visibility="{Binding HasError, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="⚠️ " 
                                      FontSize="14" 
                                      Foreground="#FFCC0000"
                                      Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding ErrorMessage}" 
                                      Foreground="#FFCC0000"
                                      TextWrapping="Wrap"/>
                        </StackPanel>
                    </Border>
                    
                    <!-- Results List -->
                    <ListBox x:Name="ResultsList"
                            Grid.Row="1"
                      ItemsSource="{Binding SearchResults}"
                            SelectedItem="{Binding SelectedResult, Mode=TwoWay}"
                            ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                            ScrollViewer.VerticalScrollBarVisibility="Auto"
                            BorderThickness="0"
                            Background="Transparent"
                            MaxHeight="360"
                            VirtualizingPanel.IsVirtualizing="True"
                            VirtualizingPanel.VirtualizationMode="Recycling"
                            PreviewKeyDown="ResultsList_PreviewKeyDown"
                            MouseDoubleClick="ResultsList_MouseDoubleClick">
                        
                        <ListBox.ItemTemplate>
            <DataTemplate DataType="{x:Type vm:SearchResultViewModel}">
                                <Border Padding="10,8" 
                                       Background="Transparent"
                                       BorderThickness="0,0,0,1"
                                       BorderBrush="{DynamicResource AppBorderBrush}">
                                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        
                        <!-- Icon -->
                        <TextBlock Grid.Column="0" 
                                  Text="{Binding ResultIcon}" 
                                  FontSize="16"
                                                  Margin="0,0,10,0"
                                                  VerticalAlignment="Top"/>
                        
                                        <!-- Title and Preview -->
                                        <StackPanel Grid.Column="1" 
                                                   VerticalAlignment="Center">
                            <TextBlock Text="{Binding Title}" 
                                      FontWeight="SemiBold" 
                                      FontSize="14"
                                      TextTrimming="CharacterEllipsis"/>
                            <ContentPresenter Content="{Binding Preview, Converter={StaticResource HighlightedTextConverter}}" 
                                            MaxHeight="32"
                                            Margin="0,2,0,0">
                                <ContentPresenter.Resources>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="FontSize" Value="12"/>
                                        <Setter Property="Opacity" Value="0.7"/>
                                        <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                        <Setter Property="TextWrapping" Value="Wrap"/>
                                    </Style>
                                </ContentPresenter.Resources>
                            </ContentPresenter>
                        </StackPanel>
                        
                                        <!-- Keyboard hint (shows when selected) -->
                        <TextBlock Grid.Column="2"
                                  Text="Enter ↵"
                                  FontSize="10"
                                  Opacity="0.5"
                                  VerticalAlignment="Center"
                                                  Margin="8,0,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsSelected, RelativeSource={RelativeSource AncestorType=ListBoxItem}}" 
                                                                   Value="True">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                    </Grid>
                </Border>
            </DataTemplate>
                        </ListBox.ItemTemplate>
                        
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                <Setter Property="Padding" Value="0"/>
                                <Setter Property="Background" Value="Transparent"/>
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border x:Name="Border"
                                                   Background="{TemplateBinding Background}"
                                                   Padding="{TemplateBinding Padding}">
                                                <ContentPresenter/>
                                            </Border>
                                            <ControlTemplate.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter TargetName="Border" Property="Background" 
                                                           Value="{DynamicResource AppSurfaceHighlightBrush}"/>
                                                </Trigger>
                                                <Trigger Property="IsSelected" Value="True">
                                                    <Setter TargetName="Border" Property="Background" 
                                                           Value="{DynamicResource AppAccentLightBrush}"/>
                                                </Trigger>
                                            </ControlTemplate.Triggers>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </Style>
                        </ListBox.ItemContainerStyle>
                    </ListBox>
                    
                    <!-- Status bar -->
                    <Border Grid.Row="2" 
                           Background="{DynamicResource AppSurfaceHighlightBrush}"
                           Padding="8,4"
                           Visibility="{Binding HasResults, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="{Binding StatusText}" 
                                  FontSize="11"
                                  Opacity="0.7"/>
                    </Border>
                    
                    <!-- No results message -->
                    <TextBlock Grid.Row="1"
                              Text="No results found"
                              HorizontalAlignment="Center"
                              VerticalAlignment="Center"
                              Padding="20"
                              Opacity="0.5"
                              Visibility="{Binding ShowNoResults, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </Grid>
            </Border>
        </Popup>
    </Grid>
</UserControl>