<UserControl x:Class="NoteNest.UI.Controls.Workspace.PaneView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:workspace="clr-namespace:NoteNest.UI.Controls.Workspace"
             xmlns:converters="clr-namespace:NoteNest.UI.Converters">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/LucideIcons.xaml"/>
            </ResourceDictionary.MergedDictionaries>
            <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:ActivePaneBorderConverter x:Key="ActivePaneBorderConverter"/>
            <converters:CountToVisibilityConverter x:Key="CountToVisibilityConverter"/>
            
            <!-- Tab Scroll Button Style - Modern, minimal buttons for tab navigation -->
            <Style x:Key="TabScrollButtonStyle" TargetType="Button">
                <Setter Property="Width" Value="24"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Foreground" Value="{DynamicResource AppTextSecondaryBrush}"/>
                <Setter Property="VerticalAlignment" Value="Center"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}"
                                   BorderThickness="0"
                                   CornerRadius="2">
                                <ContentPresenter HorizontalAlignment="Center" 
                                                VerticalAlignment="Center"/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{DynamicResource AppSurfaceHighlightBrush}"/>
                        <Setter Property="Foreground" Value="{DynamicResource AppTextPrimaryBrush}"/>
                    </Trigger>
                    <Trigger Property="IsPressed" Value="True">
                        <Setter Property="Background" Value="{DynamicResource AppSurfacePressedBrush}"/>
                    </Trigger>
                    <Trigger Property="IsEnabled" Value="False">
                        <Setter Property="Opacity" Value="0.3"/>
                        <Setter Property="Cursor" Value="Arrow"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <Border BorderThickness="2" 
            BorderBrush="{Binding IsActive, Converter={StaticResource ActivePaneBorderConverter}}"
            Background="{DynamicResource AppBackgroundBrush}"
            PreviewMouseDown="Border_PreviewMouseDown">
        <Border.Style>
            <Style TargetType="Border">
                <Style.Triggers>
                    <!-- Subtle highlight on hover to show pane is clickable -->
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="{DynamicResource AppSurfaceHighlightBrush}"/>
                    </Trigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Grid>
            <!-- Professional TabControl with close buttons -->
            <TabControl x:Name="TabControlElement"
                       ItemsSource="{Binding Tabs}" 
                       SelectedItem="{Binding SelectedTab, Mode=TwoWay}"
                       HorizontalAlignment="Stretch"
                       VerticalAlignment="Stretch"
                       Background="{DynamicResource AppBackgroundBrush}"
                       Foreground="{DynamicResource AppTextPrimaryBrush}"
                       BorderThickness="0"
                       GotFocus="TabControl_GotFocus">
                
                <!-- Custom Template with Scroll Buttons -->
                <TabControl.Template>
                    <ControlTemplate TargetType="TabControl">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/> <!-- Tab strip with nav buttons -->
                                <RowDefinition Height="*"/>    <!-- Content -->
                            </Grid.RowDefinitions>
                            
                            <!-- Tab Strip with Navigation Buttons -->
                            <Grid Grid.Row="0" Background="{DynamicResource AppSurfaceBrush}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/> <!-- Left scroll button -->
                                    <ColumnDefinition Width="*"/>    <!-- Scrollable tabs -->
                                    <ColumnDefinition Width="Auto"/> <!-- Right scroll button -->
                                </Grid.ColumnDefinitions>
                                
                                <!-- Step Back Button (Left) -->
                                <Button x:Name="PART_ScrollLeftButton"
                                       Grid.Column="0"
                                       Style="{StaticResource TabScrollButtonStyle}"
                                       ToolTip="Scroll tabs left"
                                       Visibility="Collapsed"
                                       Click="ScrollLeftButton_Click">
                                    <ContentControl Template="{StaticResource LucideStepBack}"
                                                   Width="16" Height="16"
                                                   Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                                </Button>
                                
                                <!-- Scrollable Tab Panel -->
                                <ScrollViewer x:Name="PART_TabScrollViewer"
                                             Grid.Column="1"
                                             HorizontalScrollBarVisibility="Hidden"
                                             VerticalScrollBarVisibility="Disabled"
                                             Background="Transparent">
                                    <TabPanel IsItemsHost="True" Background="Transparent"/>
                                </ScrollViewer>
                                
                                <!-- Step Forward Button (Right) -->
                                <Button x:Name="PART_ScrollRightButton"
                                       Grid.Column="2"
                                       Style="{StaticResource TabScrollButtonStyle}"
                                       ToolTip="Scroll tabs right"
                                       Visibility="Collapsed"
                                       Click="ScrollRightButton_Click">
                                    <ContentControl Template="{StaticResource LucideStepForward}"
                                                   Width="16" Height="16"
                                                   Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                                </Button>
                            </Grid>
                            
                            <!-- Content Area -->
                            <ContentPresenter Grid.Row="1"
                                             ContentSource="SelectedContent"
                                             HorizontalAlignment="Stretch"
                                             VerticalAlignment="Stretch"/>
                        </Grid>
                    </ControlTemplate>
                </TabControl.Template>
                
                <TabControl.ItemTemplate>
                    <DataTemplate>
                        <!-- Professional tab header with close button (from Milestone 1) -->
                        <!-- Tier 1 Features: Middle-click support + Context menu -->
                        <Grid MaxWidth="200" ToolTip="{Binding Note.FilePath}" 
                              PreviewMouseDown="TabHeader_PreviewMouseDown"
                              Tag="{Binding}">
                            <Grid.ContextMenu>
                                <ContextMenu x:Name="TabContextMenu" ContextMenuOpening="OnContextMenuOpened">
                                    <MenuItem Header="Close Tab" 
                                              Click="ContextMenu_CloseTab_Click"
                                              Tag="{Binding}"/>
                                    <MenuItem Header="Close Other Tabs" 
                                              Click="ContextMenu_CloseOtherTabs_Click"
                                              Tag="{Binding}"/>
                                    <MenuItem Header="Close All Tabs" 
                                              Click="ContextMenu_CloseAllTabs_Click"/>
                                    <Separator/>
                                    <MenuItem Header="Move to Other Pane" 
                                              Click="ContextMenu_MoveToOtherPane_Click"
                                              Tag="{Binding}"/>
                                    <Separator/>
                                    <!-- Tear-Out Functionality -->
                                    <MenuItem Header="Detach Tab" 
                                              Click="ContextMenu_DetachTab_Click"
                                              Tag="{Binding}"
                                              ToolTip="Open this tab in a separate window (Ctrl+Shift+D)">
                                        <MenuItem.Icon>
                                            <ContentControl Template="{StaticResource LucideSquareArrowUpRight}"
                                                          Foreground="{DynamicResource AppForegroundBrush}"
                                                          Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Detach Other Tabs" 
                                              Click="ContextMenu_DetachOtherTabs_Click"
                                              Tag="{Binding}"
                                              ToolTip="Move all other tabs to a new detached window">
                                        <MenuItem.Icon>
                                            <ContentControl Template="{StaticResource LucideArrowRightToLine}"
                                                          Foreground="{DynamicResource AppForegroundBrush}"
                                                          Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <!-- Redock option (only shown in detached windows) -->
                                    <MenuItem Header="Redock to Main Window" 
                                              Click="ContextMenu_RedockTab_Click"
                                              Tag="{Binding}"
                                              ToolTip="Move this tab back to the main window"
                                              x:Name="RedockMenuItem"
                                              Visibility="Collapsed">
                                        <MenuItem.Icon>
                                            <ContentControl Template="{StaticResource LucideArrowLeftToLine}"
                                                          Foreground="{DynamicResource AppForegroundBrush}"
                                                          Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                    <MenuItem Header="Redock All Tabs" 
                                              Click="ContextMenu_RedockAllTabs_Click"
                                              ToolTip="Move all tabs in this window back to the main window"
                                              x:Name="RedockAllMenuItem"
                                              Visibility="Collapsed">
                                        <MenuItem.Icon>
                                            <ContentControl Template="{StaticResource LucideArrowLeftToLine}"
                                                          Foreground="{DynamicResource AppForegroundBrush}"
                                                          Width="12" Height="12"/>
                                        </MenuItem.Icon>
                                    </MenuItem>
                                </ContextMenu>
                            </Grid.ContextMenu>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>       <!-- Title -->
                                <ColumnDefinition Width="Auto"/>    <!-- Dirty indicator -->
                                <ColumnDefinition Width="24"/>      <!-- Close button -->
                            </Grid.ColumnDefinitions>
                            
                            <!-- Title with ellipsis truncation -->
                            <TextBlock Grid.Column="0" 
                                       Text="{Binding Title}"
                                       TextTrimming="CharacterEllipsis"
                                       Margin="8,4,4,4"
                                       VerticalAlignment="Center"/>
                            
                            <!-- Dirty indicator (uses Opacity instead of Visibility to prevent tab width jumping) -->
                            <TextBlock Grid.Column="1" 
                                       Text="·" 
                                       Foreground="{DynamicResource AppWarningBrush}"
                                       FontWeight="Bold"
                                       FontSize="16"
                                       Margin="2,4"
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Opacity" Value="0"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsDirty}" Value="True">
                                                <Setter Property="Opacity" Value="1"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            
                            <!-- Close button with LucideCircleX icon (shows on tab hover) -->
                            <Button Grid.Column="2"
                                    Click="CloseTab_Click"
                                    Tag="{Binding}"
                                    Width="20" Height="20"
                                    Margin="2,2"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    ToolTip="Close tab (Ctrl+W)"
                                    x:Name="TabCloseButton">
                                <ContentControl Template="{StaticResource LucideCircleX}" 
                                              Width="14" Height="14"
                                              Foreground="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Foreground}"/>
                                <Button.Style>
                                    <Style TargetType="Button">
                                        <Setter Property="Foreground" Value="{DynamicResource AppTextSecondaryBrush}"/>
                                        <Setter Property="Cursor" Value="Hand"/>
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <!-- Show close button when hovering over entire tab (TabItem) -->
                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=TabItem}, Path=IsMouseOver}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                            
                                            <!-- Red highlight when hovering over button itself -->
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter Property="Foreground" Value="{DynamicResource AppTextOnAccentBrush}"/>
                                                <Setter Property="Background" Value="{DynamicResource AppErrorBrush}"/>
                                            </Trigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </Grid>
                    </DataTemplate>
                </TabControl.ItemTemplate>
                
                <!-- Tab Item Style - Modernized VS Code Style with Enhanced Visual Feedback -->
                <TabControl.ItemContainerStyle>
                    <Style TargetType="TabItem">
                        <Setter Property="Background" Value="{DynamicResource AppSurfaceBrush}"/>
                        <Setter Property="Foreground" Value="{DynamicResource AppTextSecondaryBrush}"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Padding" Value="0"/>
                        <!-- ✨ MODERNIZED: Increased spacing from 1px to 2px for better visual separation -->
                        <Setter Property="Margin" Value="0,0,2,0"/>
                        <Setter Property="Opacity" Value="0.85"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="TabItem">
                                    <Grid>
                                        <!-- ✨ MODERNIZED: Increased corner radius from 4px to 6px (industry standard) -->
                                        <Border x:Name="TabBorder"
                                               Background="{TemplateBinding Background}"
                                               BorderThickness="0,0,0,2"
                                               BorderBrush="Transparent"
                                               CornerRadius="6,6,0,0"
                                               Padding="4,6,4,4"
                                               Margin="0">
                                            <!-- Subtle drop shadow for depth (hardware accelerated, negligible performance impact) -->
                                            <Border.Effect>
                                                <DropShadowEffect Color="Black" 
                                                                 Opacity="0.15" 
                                                                 BlurRadius="4" 
                                                                 ShadowDepth="2" 
                                                                 Direction="270"/>
                                            </Border.Effect>
                                            <!-- This properly renders the ItemTemplate content (Grid with Title, Dirty indicator, Close button) -->
                                            <ContentPresenter x:Name="ContentSite"
                                                            ContentSource="Header"
                                                            HorizontalAlignment="Stretch"
                                                            VerticalAlignment="Center"
                                                            RecognizesAccessKey="True"/>
                                        </Border>
                                    </Grid>
                                    <ControlTemplate.Triggers>
                                        <!-- Active tab with enhanced visual hierarchy -->
                                        <Trigger Property="IsSelected" Value="True">
                                            <Setter Property="Background" Value="{DynamicResource AppBackgroundBrush}"/>
                                            <Setter Property="Foreground" Value="{DynamicResource AppTextPrimaryBrush}"/>
                                            <Setter Property="Opacity" Value="1.0"/>
                                            <Setter TargetName="TabBorder" Property="BorderBrush" Value="{DynamicResource AppAccentBrush}"/>
                                        </Trigger>
                                        <!-- Hover state with smooth transitions (not selected) -->
                                        <MultiTrigger>
                                            <MultiTrigger.Conditions>
                                                <Condition Property="IsMouseOver" Value="True"/>
                                                <Condition Property="IsSelected" Value="False"/>
                                            </MultiTrigger.Conditions>
                                            <!-- ✨ MODERNIZED: Smooth fade-in animation (150ms) -->
                                            <MultiTrigger.EnterActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                        To="0.95"
                                                                        Duration="0:0:0.15"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </MultiTrigger.EnterActions>
                                            <!-- ✨ MODERNIZED: Smooth fade-out animation (150ms) -->
                                            <MultiTrigger.ExitActions>
                                                <BeginStoryboard>
                                                    <Storyboard>
                                                        <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                        To="0.85"
                                                                        Duration="0:0:0.15"/>
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </MultiTrigger.ExitActions>
                                            <!-- Fallback setters (instant if animation fails) -->
                                            <Setter Property="Background" Value="{DynamicResource AppSurfaceHighlightBrush}"/>
                                            <Setter Property="Opacity" Value="0.95"/>
                                        </MultiTrigger>
                                    </ControlTemplate.Triggers>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </TabControl.ItemContainerStyle>
                
                <TabControl.ContentTemplate>
                    <DataTemplate>
                        <!-- TabContentView hosts the RTF editor -->
                        <workspace:TabContentView DataContext="{Binding}"
                                                 HorizontalAlignment="Stretch"
                                                 VerticalAlignment="Stretch"/>
                    </DataTemplate>
                </TabControl.ContentTemplate>
            </TabControl>
            
            <!-- Placeholder when no tabs -->
            <TextBlock Text="No tabs in this pane" 
                      HorizontalAlignment="Center" 
                      VerticalAlignment="Center" 
                      Foreground="{DynamicResource AppTextSecondaryBrush}"
                      FontStyle="Italic"
                      IsHitTestVisible="False"
                      Background="{DynamicResource AppBackgroundBrush}">
                <TextBlock.Visibility>
                    <Binding Path="Tabs.Count">
                        <Binding.Converter>
                            <converters:CountToVisibilityConverter/>
                        </Binding.Converter>
                    </Binding>
                </TextBlock.Visibility>
            </TextBlock>
            
            <!-- Floating close button (only when pane is empty and in split view) -->
            <Button HorizontalAlignment="Right" 
                    VerticalAlignment="Top"
                    Width="24" Height="24"
                    Margin="8"
                    Background="{DynamicResource AppSurfaceHighlightBrush}"
                    BorderThickness="1"
                    BorderBrush="{DynamicResource AppBorderBrush}"
                    ToolTip="Close this empty pane"
                    Click="ClosePane_Click"
                    Panel.ZIndex="100">
                <ContentControl Template="{StaticResource LucideCircleX}" 
                              Width="14" Height="14"
                              Foreground="{DynamicResource AppTextSecondaryBrush}"/>
                <Button.Style>
                    <Style TargetType="Button">
                        <Setter Property="Cursor" Value="Hand"/>
                        <Setter Property="Opacity" Value="0.7"/>
                        <Setter Property="Visibility" Value="Collapsed"/>
                        
                        <!-- Only show when: split view AND no tabs -->
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding RelativeSource={RelativeSource AncestorType=UserControl}, Path=ShowPaneCloseButton}" Value="True"/>
                                    <Condition Binding="{Binding Tabs.Count}" Value="0"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                            
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="1"/>
                                <Setter Property="Background" Value="{DynamicResource AppSurfacePressedBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Button.Style>
            </Button>
        </Grid>
    </Border>
</UserControl>
