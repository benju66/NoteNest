<UserControl x:Class="NoteNest.UI.Plugins.TodoPlugin.UI.Views.TodoPanelView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NoteNest.UI.Plugins.TodoPlugin.UI.Views"
             xmlns:vm="clr-namespace:NoteNest.UI.Plugins.TodoPlugin.UI.ViewModels"
             xmlns:converters="clr-namespace:NoteNest.UI.Plugins.TodoPlugin.UI.Converters"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             xmlns:System="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="350">
    
    <UserControl.Resources>
        <!-- Converters -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <converters:InverseBooleanToVisibilityConverter x:Key="InverseBooleanToVisibilityConverter"/>
        <converters:BoolToStrikethroughConverter x:Key="BoolToStrikethroughConverter"/>
        <converters:BoolToErrorBrushConverter x:Key="BoolToErrorBrushConverter"/>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Quick Add -->
            <RowDefinition Height="Auto"/> <!-- Categories -->
            <RowDefinition Height="*"/> <!-- Todo List -->
        </Grid.RowDefinitions>
        
        <!-- Quick Add Bar -->
        <Border Grid.Row="0" 
                Background="{DynamicResource SystemControlBackgroundChromeMediumBrush}"
                Padding="12,8">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <TextBox x:Name="QuickAddTextBox"
                         Grid.Column="0"
                         Text="{Binding TodoList.QuickAddText, UpdateSourceTrigger=PropertyChanged}"
                         KeyDown="QuickAddTextBox_KeyDown"/>
                
                <Button Grid.Column="1"
                        Margin="8,0,0,0"
                        Command="{Binding TodoList.QuickAddCommand}"
                        IsDefault="True"
                        Content="Add"/>
            </Grid>
        </Border>
        
        <!-- Categories Section - SIMPLE AND CLEAN -->
        <Border Grid.Row="1"
                Background="{DynamicResource SystemControlBackgroundAltHighBrush}"
                BorderBrush="{DynamicResource SystemControlBackgroundBaseLowBrush}"
                BorderThickness="0,0,0,1"
                Padding="12,8">
            <StackPanel>
                <TextBlock Text="CATEGORIES" 
                           FontSize="11" 
                           FontWeight="SemiBold"
                           Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           Margin="0,0,0,4"/>
                
                <!-- UNIFIED TREEVIEW - Categories contain Todos -->
                <TreeView ItemsSource="{Binding CategoryTree.Categories}"
                          Background="Transparent"
                          BorderThickness="0"
                          MinHeight="100"
                          MaxHeight="200"
                          Padding="0"
                          x:Name="CategoryTreeView"
                          KeyDown="CategoryTreeView_KeyDown">
                    <TreeView.Resources>
                        <!-- Context Menu for Todos -->
                        <ContextMenu x:Key="TodoContextMenu">
                            <MenuItem Header="_Edit" Command="{Binding StartEditCommand}" InputGestureText="F2">
                                <MenuItem.Icon>
                                    <ContentControl Template="{StaticResource LucidePencil}"
                                                    Width="12" Height="12"
                                                    Foreground="{DynamicResource AppAccentBrush}"/>
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator/>
                            <MenuItem Header="Set _Priority">
                                <MenuItem Header="_Low" Command="{Binding SetPriorityCommand}" CommandParameter="0"/>
                                <MenuItem Header="_Normal" Command="{Binding SetPriorityCommand}" CommandParameter="1"/>
                                <MenuItem Header="_High" Command="{Binding SetPriorityCommand}" CommandParameter="2"/>
                                <MenuItem Header="_Urgent" Command="{Binding SetPriorityCommand}" CommandParameter="3"/>
                            </MenuItem>
                            <MenuItem Header="Set _Due Date" Command="{Binding SetDueDateCommand}"/>
                            <Separator/>
                            <MenuItem Header="Toggle _Favorite" Command="{Binding ToggleFavoriteCommand}"/>
                        </ContextMenu>
                        
                        <!-- Category template - displays folder with child categories and todos -->
                        <HierarchicalDataTemplate DataType="{x:Type vm:CategoryNodeViewModel}"
                                                  ItemsSource="{Binding AllItems}">
                            <StackPanel Orientation="Horizontal" Margin="2">
                                <TextBlock Text="ðŸ“" FontSize="12" Margin="0,0,4,0" Foreground="#FFA500"/>
                                <TextBlock Text="{Binding Name}" FontSize="11" FontWeight="Medium"/>
                                <TextBlock Text="{Binding Todos.Count, StringFormat=' ({0})'}" 
                                           FontSize="10" 
                                           Foreground="Gray" 
                                           Margin="4,0,0,0"/>
                            </StackPanel>
                        </HierarchicalDataTemplate>
                        
                        <!-- Todo template - ENHANCED with priority, date, editing -->
                        <DataTemplate DataType="{x:Type vm:TodoItemViewModel}">
                            <Border Padding="4,2" 
                                    Background="Transparent" 
                                    Cursor="Hand"
                                    ContextMenu="{StaticResource TodoContextMenu}"
                                    MouseLeftButtonDown="TodoText_MouseLeftButtonDown">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Checkbox -->
                                    <CheckBox Grid.Column="0"
                                              IsChecked="{Binding IsCompleted}" 
                                              Margin="0,0,8,0"
                                              VerticalAlignment="Center"
                                              Command="{Binding ToggleCompletionCommand}"/>
                                    
                                    <!-- Text (editable) -->
                                    <Grid Grid.Column="1">
                                        <TextBlock Text="{Binding Text}" 
                                                   FontSize="11"
                                                   VerticalAlignment="Center"
                                                   TextWrapping="Wrap"
                                                   Visibility="{Binding IsEditing, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
                                        
                                        <TextBox x:Name="EditTextBox"
                                                 Text="{Binding EditingText, UpdateSourceTrigger=PropertyChanged}"
                                                 FontSize="11"
                                                 Visibility="{Binding IsEditing, Converter={StaticResource BooleanToVisibilityConverter}}"
                                                 KeyDown="EditTextBox_KeyDown"
                                                 LostFocus="EditTextBox_LostFocus"
                                                 BorderThickness="0"
                                                 Background="Transparent"/>
                                    </Grid>
                                    
                                    <!-- Actions -->
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Margin="4,0,0,0">
                                        <!-- Priority Flag -->
                                        <Button Width="16" Height="16"
                                                Background="Transparent"
                                                BorderThickness="0"
                                                Command="{Binding CyclePriorityCommand}"
                                                ToolTip="{Binding PriorityTooltip}"
                                                Cursor="Hand"
                                                Padding="0"
                                                Margin="0,0,2,0">
                                            <ContentControl Template="{StaticResource LucideFlag}"
                                                            Width="12" Height="12"
                                                            Foreground="{Binding PriorityBrush}"/>
                                        </Button>
                                        
                                        <!-- Favorite Star -->
                                        <TextBlock Text="â­" 
                                                   FontSize="10" 
                                                   Margin="0,0,2,0"
                                                   VerticalAlignment="Center"
                                                   Visibility="{Binding IsFavorite, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </TreeView.Resources>
                    
                    <TreeView.ItemContainerStyle>
                        <Style TargetType="TreeViewItem">
                            <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}"/>
                            <Setter Property="Padding" Value="2,1"/>
                        </Style>
                    </TreeView.ItemContainerStyle>
                </TreeView>
                
                <!-- Empty state message -->
                <TextBlock Text="Right-click folders in note tree to add categories"
                           FontSize="10"
                           FontStyle="Italic"
                       Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}"
                           Margin="0,8,0,0"
                           TextWrapping="Wrap">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock">
                            <Setter Property="Visibility" Value="Collapsed"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CategoryTree.Categories.Count}" Value="0">
                                    <Setter Property="Visibility" Value="Visible"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
        
        <!-- Removed: Todos now live inside categories in the tree above -->
    </Grid>
</UserControl>
